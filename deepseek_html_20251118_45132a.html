<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PG-SGA ç‡Ÿé¤Šè©•ä¼°å•å·</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(45deg, #4a90e2, #357abd);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 { font-size: 2.2em; margin: 0 0 10px 0; }
        .tabs {
            display: flex;
            background: #f8f9fa;
        }
        .tab-button {
            flex: 1;
            padding: 15px;
            background: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .tab-button.active { background: white; color: #4a90e2; }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .section {
            background: #f8f9fa;
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #4a90e2;
        }
        .section h3 { color: #2c3e50; margin-bottom: 15px; }
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 8px; margin: 10px 0; }
        .radio-item, .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        .radio-item:hover, .checkbox-item:hover { border-color: #4a90e2; }
        .radio-item input, .checkbox-item input { 
            margin-right: 10px; 
            transform: scale(1.2);
        }
        .score { 
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
            text-align: center;
            font-size: 18px;
        }
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin: 5px;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
        }
        .btn-primary { background: #4a90e2; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-sm { padding: 8px 15px; font-size: 14px; }
        .btn:hover { opacity: 0.9; }
        .total-score {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin: 15px 0;
        }
        .record { border: 1px solid #ddd; margin: 15px 0; padding: 15px; border-radius: 8px; }
        .record-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        
        .additional-data {
            margin-top: 30px;
        }
        .additional-data textarea {
            min-height: 120px;
            font-size: 16px;
        }
        
        /* è©³ç´°è³‡æ–™æ¨£å¼ */
        .detail-section {
            background: white;
            margin: 10px 0;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 5px;
        }
        .detail-item {
            margin: 8px 0;
            padding: 5px 0;
        }
        .detail-label {
            font-weight: bold;
            color: #495057;
            display: inline-block;
            width: 150px;
        }
        .detail-value {
            color: #212529;
        }
        
        /* åˆ—å°æ¨£å¼ */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 10pt !important;
                font-family: 'Microsoft JhengHei', Arial, sans-serif !important;
            }
            .container {
                max-width: 100% !important;
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                padding: 10mm !important;
            }
            .no-print, .tabs, .btn, .tab-button {
                display: none !important;
            }
            
            .print-section {
                margin: 3mm 0 !important;
                padding: 2mm !important;
                border: 0.5px solid #999 !important;
                background: white !important;
                page-break-inside: avoid !important;
            }
            
            .print-grid {
                display: grid !important;
                grid-template-columns: 1fr 1fr !important;
                gap: 2mm !important;
                margin-bottom: 2mm !important;
            }
            
            .print-title {
                font-weight: bold !important;
                margin-bottom: 1mm !important;
                font-size: 11pt !important;
                border-bottom: 0.5px solid #333 !important;
                padding-bottom: 0.5mm !important;
            }
            
            .print-item {
                margin: 0.5mm 0 !important;
                font-size: 9pt !important;
            }
            
            .print-score {
                font-weight: bold !important;
                background: #f8f9fa !important;
                padding: 1mm !important;
                border-radius: 1mm !important;
                font-size: 9pt !important;
                text-align: center !important;
            }
            
            .print-total {
                font-weight: bold !important;
                font-size: 14pt !important;
                text-align: center !important;
                margin: 3mm 0 !important;
                padding: 2mm !important;
                background: #e9ecef !important;
                border: 1px solid #333 !important;
            }
            
            .print-advice {
                font-weight: bold !important;
                margin: 2mm 0 !important;
                padding: 2mm !important;
                background: #d4edda !important;
                border: 1px solid #28a745 !important;
                text-align: center !important;
                font-size: 11pt !important;
            }
        }
        
        @media (max-width: 768px) {
            .form-row { flex-direction: column; }
            .tabs { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¥ PG-SGA ç‡Ÿé¤Šè©•ä¼°ç³»çµ±</h1>
            <p>Patient-Generated Subjective Global Assessment</p>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('survey')">ğŸ“ å¡«å¯«å•å·</button>
            <button class="tab-button" onclick="switchTab('records')">ğŸ“Š æŸ¥çœ‹è¨˜éŒ„</button>
            <button class="tab-button" onclick="switchTab('export')">ğŸ’¾ åŒ¯å‡ºè³‡æ–™</button>
        </div>

        <!-- å•å·é é¢ -->
        <div id="survey" class="tab-content active">
            <form id="pgsga-form">
                <div class="section">
                    <h3>åŸºæœ¬è³‡æ–™</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>è©•ä¼°æ—¥æœŸ:</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label>å§“å:</label>
                            <input type="text" id="name" placeholder="è«‹è¼¸å…¥å§“å" required>
                        </div>
                        <div class="form-group">
                            <label>ç—…æ­·è™Ÿ:</label>
                            <input type="text" id="number" placeholder="è«‹è¼¸å…¥ç—…æ­·è™Ÿ" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>å¹´é½¡:</label>
                            <input type="number" id="age" placeholder="è«‹è¼¸å…¥å¹´é½¡" required>
                        </div>
                        <div class="form-group">
                            <label>æ€§åˆ¥:</label>
                            <select id="gender" required>
                                <option value="">è«‹é¸æ“‡æ€§åˆ¥</option>
                                <option value="male">ç”·</option>
                                <option value="female">å¥³</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- æ²»ç™‚æ–¹å¼å€å¡Š -->
                <div class="section">
                    <h3>æ²»ç™‚æ–¹å¼</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="treatment" value="é–‹åˆ€" id="surgery">
                            <label for="surgery">é–‹åˆ€</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="treatment" value="åŒ–ç™‚" id="chemotherapy">
                            <label for="chemotherapy">åŒ–ç™‚</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="treatment" value="æ”¾ç™‚" id="radiotherapy">
                            <label for="radiotherapy">æ”¾ç™‚</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="treatment" value="å…¶ä»–" id="other_treatment">
                            <label for="other_treatment">å…¶ä»–</label>
                            <input type="text" id="other_treatment_text" placeholder="è«‹èªªæ˜å…¶ä»–æ²»ç™‚æ–¹å¼" style="margin-left: 10px; width: 200px;">
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h3>A1. é«”é‡è®ŠåŒ–</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>ç›®å‰é«”é‡ (kg):</label>
                            <input type="number" id="currentWeight" step="0.1" placeholder="è«‹è¼¸å…¥ç›®å‰é«”é‡" required>
                        </div>
                        <div class="form-group">
                            <label>èº«é«˜ (cm):</label>
                            <input type="number" id="height" step="0.1" placeholder="è«‹è¼¸å…¥èº«é«˜" required>
                        </div>
                        <div class="form-group">
                            <label>ä¸€å€‹æœˆå‰é«”é‡ (kg):</label>
                            <input type="number" id="oneMonthWeight" step="0.1" placeholder="è«‹è¼¸å…¥ä¸€å€‹æœˆå‰é«”é‡">
                        </div>
                        <div class="form-group">
                            <label>å…­å€‹æœˆå‰é«”é‡ (kg):</label>
                            <input type="number" id="sixMonthWeight" step="0.1" placeholder="è«‹è¼¸å…¥å…­å€‹æœˆå‰é«”é‡">
                        </div>
                    </div>
                    
                    <label><strong>å…©å€‹æ˜ŸæœŸå‰é«”é‡è®ŠåŒ–:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="1" id="acute1">
                            <label for="acute1">é™ä½ (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="0" id="acute0">
                            <label for="acute0">æ²’æœ‰æ”¹è®Š (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="acuteWeight" value="0" id="acute_inc">
                            <label for="acute_inc">å¢åŠ  (0åˆ†)</label>
                        </div>
                    </div>

                    <label><strong>é«”é‡è®ŠåŒ–ç¨‹åº¦:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="4" id="sub4">
                            <label for="sub4">â‰¥10%/1å€‹æœˆ (â‰¥20%/6å€‹æœˆ) - 4åˆ†</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="3" id="sub3">
                            <label for="sub3">5-9.9%/1å€‹æœˆ (10%-19.9%/6å€‹æœˆ) - 3åˆ†</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="2" id="sub2">
                            <label for="sub2">3-4.9%/1å€‹æœˆ (6-9.9%/6å€‹æœˆ) - 2åˆ†</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="1" id="sub1">
                            <label for="sub1">2-2.9%/1å€‹æœˆ (2-5.9%/6å€‹æœˆ) - 1åˆ†</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="subAcuteWeight" value="0" id="sub0">
                            <label for="sub0">0-1.9%/1å€‹æœˆ (0-1.9%/6å€‹æœˆ) - 0åˆ†</label>
                        </div>
                    </div>
                    <div class="score" id="A1-score">A1 å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>A2. æ”é£Ÿæƒ…æ³</h3>
                    <label><strong>æœ€è¿‘æ”é£Ÿé‡èˆ‡å¹³å¸¸æ¯”è¼ƒ:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="0" id="intake_same">
                            <label for="intake_same">æ²’æ”¹è®Š (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="0" id="intake_more">
                            <label for="intake_more">å¤š (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="intakeComparison" value="1" id="intake_less">
                            <label for="intake_less">å°‘ (1åˆ†)</label>
                        </div>
                    </div>

                    <label><strong>ç›®å‰æ”é£Ÿç‹€æ³:</strong></label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="1" id="normal_less">
                            <label for="normal_less">æ­£å¸¸é£²é£Ÿä½†è¼ƒå°‘ (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="2" id="little_solid">
                            <label for="little_solid">å°‘è¨±å›ºé«”é£Ÿç‰© (2åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="3" id="liquid_food">
                            <label for="liquid_food">æ¶²é«”é£Ÿç‰© (3åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="3" id="supplements">
                            <label for="supplements">ç‡Ÿé¤Šè£œå……å“ (3åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="4" id="very_little">
                            <label for="very_little">éå¸¸å°‘ (4åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="currentIntake" value="0" id="tube_iv">
                            <label for="tube_iv">åƒ…é ç®¡çŒæˆ–éœè„ˆç‡Ÿé¤Š (0åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="A2-score">A2 å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>A3. è…¸èƒƒç—‡ç‹€</h3>
                    <label><strong>å½±éŸ¿è¿‘å…©é€±æ”é£Ÿçš„ç—‡ç‹€:</strong></label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="0" id="no_problem">
                            <label for="no_problem">æ²’æœ‰å•é¡Œ (0åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="no_appetite">
                            <label for="no_appetite">æ²’é£Ÿæ…¾ (3åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="nausea">
                            <label for="nausea">å™å¿ƒ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="vomiting">
                            <label for="vomiting">å˜”å (3åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="constipation">
                            <label for="constipation">ä¾¿ç§˜ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="3" id="diarrhea">
                            <label for="diarrhea">è…¹ç€‰ (3åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="2" id="mouth_pain">
                            <label for="mouth_pain">å£ç—› (2åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="dry_mouth">
                            <label for="dry_mouth">å£ä¹¾ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="symptoms" value="1" id="other_symptoms">
                            <label for="other_symptoms">å…¶ä»– (1åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="A3-score">A3 å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>A4. èº«é«”æ´»å‹•ç‹€æ³</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="0" id="normal_activity">
                            <label for="normal_activity">æ­£å¸¸ (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="1" id="mild_limited">
                            <label for="mild_limited">è¼•å¾®å—é™ä½†èƒ½è‡ªç† (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="2" id="severe_limited">
                            <label for="severe_limited">åš´é‡å—é™ä½†è‡¥åºŠä¸è¶…éåŠå¤© (2åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="activityStatus" value="3" id="bedridden">
                            <label for="bedridden">é•·æ™‚é–“è‡¥åºŠ (3åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="A4-score">A4 å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>B. ç–¾ç—…ç›¸é—œ</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="cancer">
                            <label for="cancer">ç™Œç—‡ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="aids">
                            <label for="aids">å…ç–«ç¼ºé™· (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="pressure_ulcer">
                            <label for="pressure_ulcer">è¤¥ç˜¡ (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="trauma">
                            <label for="trauma">å‰µå‚· (1åˆ†)</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" name="diseaseRelated" value="1" id="elderly">
                            <label for="elderly">65æ­²ä»¥ä¸Š (1åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="B-score">B å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>C. ä»£è¬å£“åŠ›</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="0" id="no_stress">
                            <label for="no_stress">æ²’æœ‰ç™¼ç‡’ã€ç„¡é¡å›ºé†‡ã€ç„¡å£“åŠ› (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="1" id="low_stress">
                            <label for="low_stress">&lt;38â„ƒã€ç™¼ç‡’æ™‚æ•¸&lt;72hã€é¡å›ºé†‡&lt;10mg prednisone/d ä½åº¦å£“åŠ› (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="2" id="moderate_stress">
                            <label for="moderate_stress">38ã€œ38.8â„ƒã€ç™¼ç‡’æ™‚æ•¸72hã€é¡å›ºé†‡10ã€œ30mg prednisone/d ä¸­åº¦å£“åŠ› (2åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="metabolicStress" value="3" id="high_stress">
                            <label for="high_stress">&gt;38.8â„ƒã€ç™¼ç‡’æ™‚&gt;72hã€é¡å›ºé†‡&gt;30mg prednisone/d é«˜åº¦å£“åŠ› (3åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="C-score">C å¾—åˆ†: 0</div>
                </div>

                <div class="section">
                    <h3>D. èº«é«”æª¢æŸ¥</h3>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="0" id="no_deficit">
                            <label for="no_deficit">æ²’ç¼ºä¹ (0åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="1" id="mild_deficit">
                            <label for="mild_deficit">è¼•åº¦ç¼ºä¹ (1åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="2" id="moderate_deficit">
                            <label for="moderate_deficit">ä¸­åº¦ç¼ºä¹ (2åˆ†)</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="physicalExam" value="3" id="severe_deficit">
                            <label for="severe_deficit">é‡åº¦ç¼ºä¹ (3åˆ†)</label>
                        </div>
                    </div>
                    <div class="score" id="D-score">D å¾—åˆ†: 0</div>
                </div>

                <!-- å…¶ä»–æ•¸æ“šå€åŸŸ -->
                <div class="section additional-data">
                    <h3>å…¶ä»–æ•¸æ“š</h3>
                    <div class="form-group">
                        <label>å…¶ä»–è§€å¯Ÿæˆ–å‚™è¨»:</label>
                        <textarea id="additional_notes" placeholder="è«‹è¼¸å…¥å…¶ä»–ç›¸é—œè§€å¯Ÿæˆ–å‚™è¨»..."></textarea>
                    </div>
                </div>

                <div class="section">
                    <div class="total-score" id="totalScore">ç¸½åˆ†: 0</div>
                    <div class="score" id="advice" style="background: #17a2b8;">å»ºè­°æœƒé¡¯ç¤ºåœ¨é€™è£¡</div>
                </div>

                <div style="text-align: center; margin: 20px 0;">
                    <button type="submit" class="btn btn-success">ğŸ’¾ å„²å­˜å•å·</button>
                    <button type="button" class="btn btn-warning" onclick="resetForm()">ğŸ”„ é‡è¨­</button>
                </div>
            </form>
        </div>

        <!-- æŸ¥çœ‹è¨˜éŒ„é é¢ -->
        <div id="records" class="tab-content">
            <div class="section">
                <h3>ğŸ“Š å•å·è¨˜éŒ„</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-primary" onclick="loadRecords(); showRecords();">ğŸ”„ é‡æ–°è¼‰å…¥</button>
                    <button class="btn btn-warning" onclick="clearRecords()">ğŸ—‘ï¸ æ¸…é™¤è¨˜éŒ„</button>
                </div>
                <div id="recordsList"></div>
            </div>
        </div>

        <!-- åŒ¯å‡ºè³‡æ–™é é¢ -->
        <div id="export" class="tab-content">
            <div class="section">
                <h3>ğŸ’¾ è³‡æ–™åŒ¯å‡ºèˆ‡åˆ—å°</h3>
                <div style="text-align: center; margin: 20px 0;">
                    <button class="btn btn-success" onclick="exportJSON()">ğŸ“„ JSON</button>
                    <button class="btn btn-primary" onclick="exportCSV()">ğŸ“Š CSV</button>
                    <button class="btn btn-warning" onclick="exportHTML()">ğŸŒ HTML</button>
                </div>
                
                <div class="section">
                    <h3>ğŸ–¨ï¸ å–®ä¸€å•å·åˆ—å°</h3>
                    <p>é¸æ“‡è¦åˆ—å°çš„å•å·è¨˜éŒ„ï¼ˆæ¯ä»½å•å·å°‡ä»¥å–®é A4æ ¼å¼åˆ—å°ï¼‰ï¼š</p>
                    <div id="printRecordsList"></div>
                </div>
                
                <div id="exportResult"></div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–è¨˜éŒ„é™£åˆ—
        let records = [];

        // è¼‰å…¥è¨˜éŒ„
        function loadRecords() {
            try {
                const stored = localStorage.getItem('pgsga_records');
                records = stored ? JSON.parse(stored) : [];
                console.log('è¼‰å…¥è¨˜éŒ„:', records.length, 'ç­†');
            } catch (e) {
                console.error('è¼‰å…¥è¨˜éŒ„éŒ¯èª¤:', e);
                records = [];
            }
        }

        // å„²å­˜è¨˜éŒ„
        function saveRecords() {
            try {
                localStorage.setItem('pgsga_records', JSON.stringify(records));
                console.log('å„²å­˜è¨˜éŒ„æˆåŠŸ');
            } catch (e) {
                console.error('å„²å­˜è¨˜éŒ„éŒ¯èª¤:', e);
            }
        }

        // åˆ‡æ›æ¨™ç±¤é 
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(el => {
                el.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'records') {
                showRecords();
            }
            if (tabName === 'export') {
                showPrintRecords();
            }
        }

        // æ›´æ–°åˆ†æ•¸
        function updateScores() {
            console.log('æ›´æ–°åˆ†æ•¸...');
            
            // A1 é«”é‡è®ŠåŒ–
            const acute = parseInt(document.querySelector('input[name="acuteWeight"]:checked')?.value || 0);
            const subAcute = parseInt(document.querySelector('input[name="subAcuteWeight"]:checked')?.value || 0);
            const a1 = acute + subAcute;
            document.getElementById('A1-score').textContent = `A1 å¾—åˆ†: ${a1}`;

            // A2 æ”é£Ÿæƒ…æ³
            const intake1 = parseInt(document.querySelector('input[name="intakeComparison"]:checked')?.value || 0);
            const intake2 = parseInt(document.querySelector('input[name="currentIntake"]:checked')?.value || 0);
            const a2 = Math.max(intake1, intake2);
            document.getElementById('A2-score').textContent = `A2 å¾—åˆ†: ${a2}`;

            // A3 è…¸èƒƒç—‡ç‹€
            const symptoms = document.querySelectorAll('input[name="symptoms"]:checked');
            const a3 = Array.from(symptoms).reduce((sum, s) => sum + parseInt(s.value), 0);
            document.getElementById('A3-score').textContent = `A3 å¾—åˆ†: ${a3}`;

            // A4 èº«é«”æ´»å‹•
            const a4 = parseInt(document.querySelector('input[name="activityStatus"]:checked')?.value || 0);
            document.getElementById('A4-score').textContent = `A4 å¾—åˆ†: ${a4}`;

            // B ç–¾ç—…ç›¸é—œ
            const diseases = document.querySelectorAll('input[name="diseaseRelated"]:checked');
            const b = Array.from(diseases).reduce((sum, d) => sum + parseInt(d.value), 0);
            document.getElementById('B-score').textContent = `B å¾—åˆ†: ${b}`;

            // C ä»£è¬å£“åŠ›
            const c = parseInt(document.querySelector('input[name="metabolicStress"]:checked')?.value || 0);
            document.getElementById('C-score').textContent = `C å¾—åˆ†: ${c}`;

            // D èº«é«”æª¢æŸ¥
            const d = parseInt(document.querySelector('input[name="physicalExam"]:checked')?.value || 0);
            document.getElementById('D-score').textContent = `D å¾—åˆ†: ${d}`;

            // ç¸½åˆ†
            const total = a1 + a2 + a3 + a4 + b + c + d;
            document.getElementById('totalScore').textContent = `ç¸½åˆ†: ${total}`;

            // å»ºè­°
            let advice = '';
            if (total >= 9) {
                advice = 'ğŸš¨ åš´é‡ç‡Ÿé¤Šä¸è‰¯é¢¨éšª';
            } else if (total >= 4) {
                advice = 'âš ï¸ ä¸­åº¦ç‡Ÿé¤Šä¸è‰¯é¢¨éšª';
            } else {
                advice = 'âœ… ç‡Ÿé¤Šç‹€æ³è‰¯å¥½';
            }
            document.getElementById('advice').textContent = advice;

            return { a1, a2, a3, a4, b, c, d, total, advice };
        }

        // æ”¶é›†è¡¨å–®è³‡æ–™
        function collectData() {
            const getSelected = (name) => {
                const el = document.querySelector(`input[name="${name}"]:checked`);
                return el ? { 
                    value: el.value, 
                    text: el.nextElementSibling.textContent.trim() 
                } : null;
            };

            const getMultiSelected = (name) => {
                const els = document.querySelectorAll(`input[name="${name}"]:checked`);
                return Array.from(els).map(el => ({
                    value: el.value,
                    text: el.nextElementSibling.textContent.trim()
                }));
            };

            // è™•ç†æ²»ç™‚æ–¹å¼
            const treatments = getMultiSelected('treatment');
            let treatmentText = treatments.map(t => t.text).join('ï¼› ');
            
            // å¦‚æœæœ‰å…¶ä»–æ²»ç™‚æ–¹å¼ï¼ŒåŠ å…¥æ–‡å­—
            const otherTreatment = document.getElementById('other_treatment_text').value;
            if (otherTreatment) {
                if (treatmentText) treatmentText += 'ï¼› ';
                treatmentText += 'å…¶ä»–ï¼š' + otherTreatment;
            }

            const data = {
                date: document.getElementById('date').value,
                name: document.getElementById('name').value,
                number: document.getElementById('number').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                currentWeight: document.getElementById('currentWeight').value,
                height: document.getElementById('height').value,
                oneMonthWeight: document.getElementById('oneMonthWeight').value,
                sixMonthWeight: document.getElementById('sixMonthWeight').value,
                treatment: treatmentText,
                acuteWeight: getSelected('acuteWeight'),
                subAcuteWeight: getSelected('subAcuteWeight'),
                intakeComparison: getSelected('intakeComparison'),
                currentIntake: getSelected('currentIntake'),
                symptoms: getMultiSelected('symptoms'),
                activityStatus: getSelected('activityStatus'),
                diseaseRelated: getMultiSelected('diseaseRelated'),
                metabolicStress: getSelected('metabolicStress'),
                physicalExam: getSelected('physicalExam'),
                additionalNotes: document.getElementById('additional_notes').value,
                scores: updateScores(),
                timestamp: new Date().toISOString()
            };
            
            console.log('æ”¶é›†çš„è³‡æ–™:', data);
            return data;
        }

        // Helper: æŠŠé¸é …ç‰©ä»¶/é™£åˆ—è½‰æˆå¯é¡¯ç¤ºæ–‡å­—
        function selText(sel) {
            if (!sel) return '';
            if (Array.isArray(sel)) return sel.map(s => s.text).join('ï¼› ');
            return sel.text || '';
        }

        // é‡è¨­è¡¨å–®
        function resetForm() {
            if (confirm('ç¢ºå®šè¦é‡è¨­è¡¨å–®å—ï¼Ÿæ‰€æœ‰è¼¸å…¥çš„è³‡æ–™å°‡æœƒéºå¤±ã€‚')) {
                document.getElementById('pgsga-form').reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                updateScores();
            }
        }

        // é¡¯ç¤ºè©³ç´°è³‡æ–™
        function showRecordDetails(record, index) {
            return `
                <div class="detail-section">
                    <h4>ğŸ“‹ è©³ç´°å¡«å¯«è³‡æ–™</h4>
                    
                    <div class="detail-item">
                        <span class="detail-label">åŸºæœ¬è³‡æ–™:</span>
                        <span class="detail-value">${record.age}æ­² ${record.gender === 'male' ? 'ç”·' : 'å¥³'} | èº«é«˜:${record.height}cm | é«”é‡:${record.currentWeight}kg</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">é«”é‡æ•¸æ“š:</span>
                        <span class="detail-value">ç›®å‰:${record.currentWeight}kg | ä¸€å€‹æœˆå‰:${record.oneMonthWeight || 'æœªå¡«'}kg | å…­å€‹æœˆå‰:${record.sixMonthWeight || 'æœªå¡«'}kg</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">æ²»ç™‚æ–¹å¼:</span>
                        <span class="detail-value">${record.treatment || 'ç„¡'}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">A1. é«”é‡è®ŠåŒ–:</span>
                        <span class="detail-value">${selText(record.acuteWeight)}ï¼›${selText(record.subAcuteWeight)}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">A2. æ”é£Ÿæƒ…æ³:</span>
                        <span class="detail-value">${selText(record.intakeComparison)}ï¼›${selText(record.currentIntake)}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">A3. è…¸èƒƒç—‡ç‹€:</span>
                        <span class="detail-value">${selText(record.symptoms) || 'ç„¡ç—‡ç‹€'}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">A4. èº«é«”æ´»å‹•:</span>
                        <span class="detail-value">${selText(record.activityStatus)}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">B. ç–¾ç—…ç›¸é—œ:</span>
                        <span class="detail-value">${selText(record.diseaseRelated) || 'ç„¡'}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">C. ä»£è¬å£“åŠ›:</span>
                        <span class="detail-value">${selText(record.metabolicStress)}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">D. èº«é«”æª¢æŸ¥:</span>
                        <span class="detail-value">${selText(record.physicalExam)}</span>
                    </div>
                    
                    ${record.additionalNotes ? `
                    <div class="detail-item">
                        <span class="detail-label">å…¶ä»–æ•¸æ“š:</span>
                        <span class="detail-value">${record.additionalNotes}</span>
                    </div>
                    ` : ''}
                    
                    <div class="detail-item">
                        <span class="detail-label">å„é …åˆ†æ•¸:</span>
                        <span class="detail-value">A1:${record.scores.a1} | A2:${record.scores.a2} | A3:${record.scores.a3} | A4:${record.scores.a4} | B:${record.scores.b} | C:${record.scores.c} | D:${record.scores.d}</span>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">ç¸½åˆ†èˆ‡å»ºè­°:</span>
                        <span class="detail-value"><strong>${record.scores.total}åˆ† - ${record.scores.advice}</strong></span>
                    </div>
                </div>
            `;
        }

        // é¡¯ç¤ºè¨˜éŒ„
        function showRecords() {
            const list = document.getElementById('recordsList');
            if (records.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡è¨˜éŒ„</p>';
                return;
            }

            list.innerHTML = records.map((record, index) => `
                <div class="record">
                    <div class="record-header">
                        <h4>${record.name} (${record.number}) - ${new Date(record.date).toLocaleDateString('zh-TW')}</h4>
                        <div>
                            <button class="btn btn-info btn-sm" onclick="toggleDetails(${index})">ğŸ“– æŸ¥çœ‹è©³ç´°</button>
                            <button class="btn btn-warning btn-sm" onclick="deleteRecord(${index})">ğŸ—‘ï¸ åˆªé™¤</button>
                        </div>
                    </div>
                    <p><strong>åŸºæœ¬:</strong> ${record.age}æ­² ${record.gender === 'male' ? 'ç”·' : 'å¥³'} | èº«é«˜:${record.height}cm é«”é‡:${record.currentWeight}kg</p>
                    <p><strong>æ²»ç™‚æ–¹å¼:</strong> ${record.treatment || 'ç„¡'}</p>
                    <p><strong>åˆ†æ•¸:</strong> A1:${record.scores.a1} A2:${record.scores.a2} A3:${record.scores.a3} A4:${record.scores.a4} B:${record.scores.b} C:${record.scores.c} D:${record.scores.d}</p>
                    <p><strong>ç¸½åˆ†:</strong> ${record.scores.total} - ${record.scores.advice}</p>
                    <p><strong>å…¶ä»–æ•¸æ“š:</strong> ${record.additionalNotes || 'ç„¡'}</p>
                    
                    <div id="details-${index}" style="display: none; margin-top: 15px;">
                        ${showRecordDetails(record, index)}
                    </div>
                </div>
            `).join('');
        }

        // åˆ‡æ›è©³ç´°è³‡æ–™é¡¯ç¤º
        function toggleDetails(index) {
            const detailsDiv = document.getElementById(`details-${index}`);
            if (detailsDiv.style.display === 'none') {
                detailsDiv.style.display = 'block';
            } else {
                detailsDiv.style.display = 'none';
            }
        }

        // é¡¯ç¤ºå¯åˆ—å°çš„è¨˜éŒ„åˆ—è¡¨
        function showPrintRecords() {
            const list = document.getElementById('printRecordsList');
            if (records.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #666;">å°šç„¡è¨˜éŒ„å¯åˆ—å°</p>';
                return;
            }

            list.innerHTML = records.map((record, index) => `
                <div class="record">
                    <div class="record-header">
                        <h4>${record.name} (${record.number}) - ${new Date(record.date).toLocaleDateString('zh-TW')}</h4>
                        <button class="btn btn-info" onclick="printSingleRecord(${index})">ğŸ–¨ï¸ åˆ—å°æ­¤å•å·</button>
                    </div>
                    <p><strong>åŸºæœ¬:</strong> ${record.age}æ­² ${record.gender === 'male' ? 'ç”·' : 'å¥³'} | ç¸½åˆ†: ${record.scores.total} - ${record.scores.advice}</p>
                </div>
            `).join('');
        }

        // åˆªé™¤å–®ç­†è¨˜éŒ„
        function deleteRecord(index) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜éŒ„å—ï¼Ÿ')) return;
            records.splice(index, 1);
            saveRecords();
            showRecords();
            showPrintRecords();
        }

        // æ¸…é™¤è¨˜éŒ„
        function clearRecords() {
            if (confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è¨˜éŒ„å—ï¼Ÿé€™å€‹å‹•ä½œç„¡æ³•å¾©åŸã€‚')) {
                records = [];
                saveRecords();
                showRecords();
                showPrintRecords();
            }
        }

        // åˆ—å°å–®ä¸€å•å·è¨˜éŒ„
        function printSingleRecord(index) {
            const record = records[index];
            if (!record) {
                alert('æ‰¾ä¸åˆ°è¨˜éŒ„');
                return;
            }

            console.log('åˆ—å°è¨˜éŒ„:', record);

            const printHTML = `
                <div style="padding: 10mm; font-family: Microsoft JhengHei, Arial, sans-serif; font-size: 10pt;">
                    <div style="text-align: center; margin-bottom: 5mm; border-bottom: 1px solid #333; padding-bottom: 2mm;">
                        <h1 style="margin: 0; font-size: 16pt;">PG-SGA ç‡Ÿé¤Šè©•ä¼°å•å·</h1>
                        <p style="margin: 1mm 0; font-size: 10pt;">åˆ—å°æ—¥æœŸ: ${new Date().toLocaleDateString('zh-TW')}</p>
                    </div>
                    
                    <!-- åŸºæœ¬è³‡æ–™ -->
                    <div class="print-section">
                        <div class="print-title">åŸºæœ¬è³‡æ–™</div>
                        <div class="print-grid">
                            <div class="print-item"><strong>å§“å:</strong> ${record.name}</div>
                            <div class="print-item"><strong>ç—…æ­·è™Ÿ:</strong> ${record.number}</div>
                            <div class="print-item"><strong>è©•ä¼°æ—¥æœŸ:</strong> ${new Date(record.date).toLocaleDateString('zh-TW')}</div>
                            <div class="print-item"><strong>å¹´é½¡:</strong> ${record.age}æ­²</div>
                            <div class="print-item"><strong>æ€§åˆ¥:</strong> ${record.gender === 'male' ? 'ç”·' : 'å¥³'}</div>
                            <div class="print-item"><strong>æ²»ç™‚æ–¹å¼:</strong> ${record.treatment || 'ç„¡'}</div>
                        </div>
                    </div>

                    <!-- èº«é«”æ¸¬é‡ -->
                    <div class="print-section">
                        <div class="print-title">èº«é«”æ¸¬é‡æ•¸æ“š</div>
                        <div class="print-grid">
                            <div class="print-item"><strong>èº«é«˜:</strong> ${record.height} cm</div>
                            <div class="print-item"><strong>ç›®å‰é«”é‡:</strong> ${record.currentWeight} kg</div>
                            <div class="print-item"><strong>ä¸€å€‹æœˆå‰é«”é‡:</strong> ${record.oneMonthWeight || 'æœªå¡«'} kg</div>
                            <div class="print-item"><strong>å…­å€‹æœˆå‰é«”é‡:</strong> ${record.sixMonthWeight || 'æœªå¡«'} kg</div>
                        </div>
                    </div>

                    <!-- è©•ä¼°é …ç›® - å…©æ¬„ä½ˆå±€ -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2mm;">
                        <!-- å·¦æ¬„ -->
                        <div>
                            <div class="print-section">
                                <div class="print-title">A1. é«”é‡è®ŠåŒ–</div>
                                <div class="print-item">${selText(record.acuteWeight)}</div>
                                <div class="print-item">${selText(record.subAcuteWeight)}</div>
                                <div class="print-score">A1 å¾—åˆ†: ${record.scores.a1}</div>
                            </div>

                            <div class="print-section">
                                <div class="print-title">A2. æ”é£Ÿæƒ…æ³</div>
                                <div class="print-item">${selText(record.intakeComparison)}</div>
                                <div class="print-item">${selText(record.currentIntake)}</div>
                                <div class="print-score">A2 å¾—åˆ†: ${record.scores.a2}</div>
                            </div>

                            <div class="print-section">
                                <div class="print-title">A3. è…¸èƒƒç—‡ç‹€</div>
                                <div class="print-item">${selText(record.symptoms) || 'ç„¡ç—‡ç‹€'}</div>
                                <div class="print-score">A3 å¾—åˆ†: ${record.scores.a3}</div>
                            </div>
                        </div>

                        <!-- å³æ¬„ -->
                        <div>
                            <div class="print-section">
                                <div class="print-title">A4. èº«é«”æ´»å‹•</div>
                                <div class="print-item">${selText(record.activityStatus)}</div>
                                <div class="print-score">A4 å¾—åˆ†: ${record.scores.a4}</div>
                            </div>

                            <div class="print-section">
                                <div class="print-title">B. ç–¾ç—…ç›¸é—œ</div>
                                <div class="print-item">${selText(record.diseaseRelated) || 'ç„¡'}</div>
                                <div class="print-score">B å¾—åˆ†: ${record.scores.b}</div>
                            </div>

                            <div class="print-section">
                                <div class="print-title">C. ä»£è¬å£“åŠ›</div>
                                <div class="print-item">${selText(record.metabolicStress)}</div>
                                <div class="print-score">C å¾—åˆ†: ${record.scores.c}</div>
                            </div>

                            <div class="print-section">
                                <div class="print-title">D. èº«é«”æª¢æŸ¥</div>
                                <div class="print-item">${selText(record.physicalExam)}</div>
                                <div class="print-score">D å¾—åˆ†: ${record.scores.d}</div>
                            </div>
                        </div>
                    </div>

                    <!-- å…¶ä»–æ•¸æ“š -->
                    ${record.additionalNotes ? `
                    <div class="print-section">
                        <div class="print-title">å…¶ä»–æ•¸æ“š</div>
                        <div class="print-item" style="font-size: 9pt; line-height: 1.4;">${record.additionalNotes}</div>
                    </div>
                    ` : ''}

                    <!-- ç¸½åˆ†å’Œå»ºè­° -->
                    <div class="print-total">
                        ç¸½åˆ†: ${record.scores.total}
                    </div>

                    <div class="print-advice">
                        è©•ä¼°å»ºè­°: ${record.scores.advice}
                    </div>

                    <div style="text-align: center; margin-top: 3mm; font-size: 8pt; color: #666;">
                        <p>PG-SGA ç‡Ÿé¤Šè©•ä¼°å•å· - æœ¬å•å·åƒ…ä¾›é†«ç™‚å°ˆæ¥­äººå“¡ä½¿ç”¨</p>
                    </div>
                </div>
            `;

            // å»ºç«‹åˆ—å°è¦–çª—
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            if (!printWindow) {
                alert('è«‹å…è¨±å½ˆå‡ºè¦–çª—ä»¥é€²è¡Œåˆ—å°');
                return;
            }

            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>PG-SGA å•å·åˆ—å° - ${record.name}</title>
                    <meta charset="UTF-8">
                    <style>
                        body {
                            font-family: Microsoft JhengHei, Arial, sans-serif;
                            margin: 0;
                            padding: 0;
                            font-size: 10pt;
                        }
                        @media print {
                            body {
                                margin: 0;
                                padding: 0;
                            }
                            @page {
                                size: A4;
                                margin: 10mm;
                            }
                        }
                        .print-section {
                            margin: 3mm 0;
                            padding: 2mm;
                            border: 0.5px solid #999;
                            background: white;
                            page-break-inside: avoid;
                        }
                        .print-grid {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 2mm;
                            margin-bottom: 2mm;
                        }
                        .print-title {
                            font-weight: bold;
                            margin-bottom: 1mm;
                            font-size: 11pt;
                            border-bottom: 0.5px solid #333;
                            padding-bottom: 0.5mm;
                        }
                        .print-item {
                            margin: 0.5mm 0;
                            font-size: 9pt;
                        }
                        .print-score {
                            font-weight: bold;
                            background: #f8f9fa;
                            padding: 1mm;
                            border-radius: 1mm;
                            font-size: 9pt;
                            text-align: center;
                        }
                        .print-total {
                            font-weight: bold;
                            font-size: 14pt;
                            text-align: center;
                            margin: 3mm 0;
                            padding: 2mm;
                            background: #e9ecef;
                            border: 1px solid #333;
                        }
                        .print-advice {
                            font-weight: bold;
                            margin: 2mm 0;
                            padding: 2mm;
                            background: #d4edda;
                            border: 1px solid #28a745;
                            text-align: center;
                            font-size: 11pt;
                        }
                    </style>
                </head>
                <body>
                    ${printHTML}
                    <script>
                        setTimeout(() => {
                            window.print();
                        }, 500);
                    <\/script>
                </body>
                </html>
            `);
            
            printWindow.document.close();
        }

        // åŒ¯å‡ºJSON
        function exportJSON() {
            if (records.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }
            const data = JSON.stringify(records, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = '<div class="score">âœ… JSONå·²ä¸‹è¼‰</div>';
        }

        // åŒ¯å‡ºCSV
        function exportCSV() {
            if (records.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const headers = ['æ—¥æœŸ', 'å§“å', 'ç—…æ­·è™Ÿ', 'å¹´é½¡', 'æ€§åˆ¥', 'èº«é«˜', 'ç›®å‰é«”é‡', 'ä¸€å€‹æœˆå‰é«”é‡', 'å…­å€‹æœˆå‰é«”é‡', 'æ²»ç™‚æ–¹å¼', 'A1åˆ†æ•¸', 'A2åˆ†æ•¸', 'A3åˆ†æ•¸', 'A4åˆ†æ•¸', 'Båˆ†æ•¸', 'Cåˆ†æ•¸', 'Dåˆ†æ•¸', 'ç¸½åˆ†', 'å»ºè­°', 'å…¶ä»–æ•¸æ“š'];

            const escapeCSV = (v) => '"' + String(v === undefined || v === null ? '' : v).replace(/"/g, '""') + '"';

            const csvData = [
                headers.join(','),
                ...records.map(r => [
                    r.date,
                    r.name,
                    r.number,
                    r.age,
                    r.gender === 'male' ? 'ç”·' : 'å¥³',
                    r.height,
                    r.currentWeight,
                    r.oneMonthWeight || '',
                    r.sixMonthWeight || '',
                    r.treatment || '',
                    r.scores.a1,
                    r.scores.a2,
                    r.scores.a3,
                    r.scores.a4,
                    r.scores.b,
                    r.scores.c,
                    r.scores.d,
                    r.scores.total,
                    r.scores.advice,
                    r.additionalNotes || ''
                ].map(escapeCSV).join(','))
            ].join('\n');

            const blob = new Blob(['\ufeff' + csvData], { type: 'text/csv;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = '<div class="score">âœ… CSVå·²ä¸‹è¼‰</div>';
        }

        // åŒ¯å‡ºHTML
        function exportHTML() {
            if (records.length === 0) {
                alert('æ²’æœ‰è³‡æ–™å¯åŒ¯å‡º');
                return;
            }

            const html = `<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>PG-SGAè©•ä¼°å ±å‘Š</title>
    <style>
        body { font-family: Microsoft JhengHei, Arial, sans-serif; margin: 20px; }
        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .record { border: 1px solid #ddd; margin: 20px 0; padding: 15px; border-radius: 8px; }
        .record h3 { background: #f5f5f5; padding: 10px; margin: -15px -15px 15px -15px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f5f5f5; }
    </style>
</head>
<body>
    <div class="header">
        <h1>PG-SGA ç‡Ÿé¤Šè©•ä¼°å ±å‘Š</h1>
        <p>ç”Ÿæˆæ™‚é–“: ${new Date().toLocaleString('zh-TW')}</p>
    </div>
    ${records.map((r, i) => `
        <div class="record">
            <h3>è¨˜éŒ„ ${i + 1}: ${r.name} (${r.number}) - ${new Date(r.date).toLocaleDateString('zh-TW')}</h3>
            <table>
                <tr><th>é …ç›®</th><th>å…§å®¹</th></tr>
                <tr><td>åŸºæœ¬è³‡æ–™</td><td>å¹´é½¡: ${r.age}æ­², æ€§åˆ¥: ${r.gender === 'male' ? 'ç”·' : 'å¥³'}</td></tr>
                <tr><td>èº«é«”æ¸¬é‡</td><td>èº«é«˜: ${r.height}cm, é«”é‡: ${r.currentWeight}kg</td></tr>
                <tr><td>é«”é‡æ•¸æ“š</td><td>ç›®å‰: ${r.currentWeight}kg | ä¸€å€‹æœˆå‰: ${r.oneMonthWeight || 'æœªå¡«'}kg | å…­å€‹æœˆå‰: ${r.sixMonthWeight || 'æœªå¡«'}kg</td></tr>
                <tr><td>æ²»ç™‚æ–¹å¼</td><td>${r.treatment || 'ç„¡'}</td></tr>
                <tr><td>å…¶ä»–æ•¸æ“š</td><td>${r.additionalNotes || 'ç„¡'}</td></tr>
                <tr><td>å„é …åˆ†æ•¸</td><td>A1:${r.scores.a1} A2:${r.scores.a2} A3:${r.scores.a3} A4:${r.scores.a4} B:${r.scores.b} C:${r.scores.c} D:${r.scores.d}</td></tr>
                <tr><td><strong>ç¸½åˆ†</strong></td><td><strong>${r.scores.total}</strong></td></tr>
                <tr><td>å»ºè­°</td><td>${r.scores.advice}</td></tr>
            </table>
        </div>
    `).join('')}
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pgsga_report_${new Date().toISOString().split('T')[0]}.html`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('exportResult').innerHTML = '<div class="score">âœ… HTMLå ±å‘Šå·²ä¸‹è¼‰</div>';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('åˆå§‹åŒ–PG-SGAç³»çµ±...');
            
            // è¼‰å…¥è¨˜éŒ„
            loadRecords();
            
            // è¨­å®šé è¨­æ—¥æœŸç‚ºä»Šå¤©
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // ç¶å®šäº‹ä»¶ç›£è½å™¨
            document.querySelectorAll('input, select').forEach(input => {
                input.addEventListener('change', updateScores);
            });

            // è¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('pgsga-form').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('è¡¨å–®æäº¤...');
                
                const data = collectData();
                if (!data.name || !data.number || !data.age) {
                    alert('è«‹å¡«å¯«å¿…è¦è³‡æ–™ï¼ˆå§“åã€ç—…æ­·è™Ÿã€å¹´é½¡ï¼‰');
                    return;
                }
                
                records.push(data);
                saveRecords();
                alert('å•å·å·²å„²å­˜ï¼');
                switchTab('records');
            });
            
            // åˆå§‹æ›´æ–°åˆ†æ•¸
            updateScores();
            
            console.log('PG-SGAç³»çµ±åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>